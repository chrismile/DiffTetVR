# DiffTetVR

DiffTetVR is a differentiable direct volume renderer for tetrahedral meshes.


## Building and running the program

The program consists of a visualization frontend and a Python module.

### Visualization frontend

Currently, there are multiple ways to compile the program frontend:
- Linux: Using the system package manager to install all dependencies (tested: apt on Ubuntu, pacman on Arch Linux, dnf/yum on Fedora).
- Linux & Windows: Installing all dependencies using [vcpkg](https://github.com/microsoft/vcpkg)  (by using the flag `./build.sh --vcpkg` on Linux or `build-msvc.bat` on Windows).
- Windows: Using [MSYS2](https://www.msys2.org/) to install all dependencies (by using `./build.sh` in a MSYS2 shell).
- Linux: Installing all dependencies with [conda](https://docs.conda.io/en/latest/) (by using the flag `./build.sh --conda`).
- Linux: Installing all dependencies with [Nix](https://nixos.org/) (by invoking `./build.sh` after calling `nix-shell`).

A build script `build.sh` is available in the project root directory that builds the application using the system
package manager on Linux and MSYS2 on Windows. Please download and install MSYS2 from https://www.msys2.org/ if you wish
to use this build script and run the script from an MSYS2 shell.
Alternatively, we recommend to use vcpkg if the users wants to compile the application with Microsoft Visual Studio.
A build script using MSVC and vcpkg, `build-msvc.bat`, is available in the project root directory.
Please note that the [Vulkan SDK](https://vulkan.lunarg.com/sdk/home#windows) needs to be installed beforehand if using
Microsoft Visual Studio for compilation.

Under `Data/CloudDataSets/datasets.json`, loadable data sets can be specified. Additionally, the user can also open
arbitrary data sets using a file explorer via "File > Open Dataset..." (or using Ctrl+O).

Below, an example for a `Data/DataSets/datasets.json` file can be found.

```json
{
    "datasets": [
        { "name" : "Icosahedron", "filename": "mesh_ico.bintet" },
        { "name" : "Turbine", "filename": "turbine.ovm" }
    ]
}
```

These files then appear with their specified name in the menu "File > Datasets". All paths must be specified relative to
the folder `Data/DataSets/` (unless they are global, like `C:/path/file.bintet` or `/path/file.bintet`).

Supported formats currently are:
- .bintet and .txt files, which store cell indices, vertex positions and vertex colors in a binary or text-based format.
  For more information on this custom format, please refer to src/Tet/Loaders/{Bin,Txt}TetLoader.cpp.
- .ovm and .ovmb files, which are native to the library
  [OpenVolumeMesh](https://www.graphics.rwth-aachen.de/software/openvolumemesh/).
- .vtk files, which are also supported via OpenVolumeMesh.
- Gmsh .msh files (for more details see https://victorsndvg.github.io/FEconv/formats/gmshmsh.xhtml).
- MEDIT .mesh files (for more details see https://victorsndvg.github.io/FEconv/formats/gmshmsh.xhtml).

### Python module

Please note that the [Vulkan SDK](https://vulkan.lunarg.com/sdk/home#windows) needs to be installed beforehand on
Windows.

To install the library as a Python module, the following command must be called in the repository directory.

```sh
pip install .
```

If the package should be installed in a conda environment, activate the corresponding environment first as follows.

```sh
. "$HOME/miniconda3/etc/profile.d/conda.sh"
conda activate <env-name>
```

PyTorch is a necessary dependency that needs to be installed in the active Python environment.
All packages necessary for DiffTetVR and the accompanying test scripts can be installed, e.g., via conda:

```sh
export CONDA_ALWAYS_YES="true"
conda create -n diffdvr python=3.12
conda activate diffdvr
conda install pytorch torchvision torchaudio pytorch-cuda=12.4 -c pytorch -c nvidia
conda install numpy sympy numba matplotlib tqdm scikit-image conda-forge::tensorboard conda-forge::opencv conda-forge::openexr-python
```

Examples how to use the Python module can be found in the directory `pytests/`.

For more details on how to install PyTorch, see: https://pytorch.org/get-started/locally/


### CUDA Detection

If setup.py is not able to find your CUDA installation on Linux, add the following lines to the end of `$HOME/.profile`
and log out of and then back into your user account.
`cuda-12.4` needs to be adapted depending on the CUDA version installed.

```sh
export CPATH=/usr/local/cuda-12.4/targets/x86_64-linux/include:$CPATH
export LD_LIBRARY_PATH=/usr/local/cuda-12.4/targets/x86_64-linux/lib:$LD_LIBRARY_PATH
export PATH=/usr/local/cuda-12.4/bin:$PATH
```


## How to report bugs

When [reporting a bug](https://github.com/chrismile/DiffTetVR/issues), please also attach the logfile generated by this
program. Below, the location of the logfile on different operating systems can be found.

- Linux: `~/.config/difftetvr/Logfile.html`
- Windows: `C:/Users/<USER>/AppData/Roaming/DiffTetVR/Logfile.html`
